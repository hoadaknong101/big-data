{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<div class="relative h-[85vh] w-full">
    <!-- Background Image (Dynamic in real app, static for now) -->
    <div class="absolute inset-0 bg-[url('https://image.tmdb.org/t/p/original/r7DuyYJ0N3cD8bRKsR5Ygq2P7oa.jpg')] bg-cover bg-center">
        <div class="absolute inset-0 bg-gradient-to-r from-black via-black/40 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#141414] via-transparent to-transparent"></div>
    </div>

    <div class="relative z-10 flex flex-col justify-center h-full px-4 md:px-12 max-w-3xl pt-20">
        <h1 class="text-5xl md:text-7xl font-bold mb-6 drop-shadow-lg">Dark</h1>
        <div class="flex items-center gap-4 text-gray-300 mb-6 text-sm md:text-base font-medium">
            <span class="text-[#46d369] font-bold">98% Match</span>
            <span>2017</span>
            <span class="border border-gray-500 px-1 text-xs">TV-MA</span>
            <span>3 Seasons</span>
            <span class="border border-gray-500 px-1 text-xs">HD</span>
        </div>
        <p class="text-lg md:text-xl text-gray-200 mb-8 drop-shadow-md line-clamp-3">
            A missing child sets four families on a frantic hunt for answers as they unearth a mind-bending mystery that spans three generations.
        </p>
        <div class="flex items-center gap-4">
            <!-- Link to a random/featured movie (e.g., ID 1 for now) -->
            <a href="{{ url_for('main.watch', movie_id=1) }}" class="bg-white text-black px-6 md:px-8 py-2 md:py-3 rounded font-bold flex items-center gap-2 hover:bg-opacity-80 transition">
                <i class="fas fa-play"></i> Play
            </a>
            <button class="bg-[rgba(109,109,110,0.7)] text-white px-6 md:px-8 py-2 md:py-3 rounded font-bold flex items-center gap-2 hover:bg-[rgba(109,109,110,0.4)] transition">
                <i class="fas fa-info-circle"></i> More Info
            </button>
        </div>
    </div>
</div>

<!-- Movie Rows -->
<div class="relative z-20 -mt-32 pb-20 space-y-12 px-4 md:px-12">
    
    <!-- Row Component -->
    <div class="movie-row group">
        <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-100 hover:text-white transition cursor-pointer">Trending Now</h2>
        <div class="relative">
            <button class="absolute left-0 top-0 bottom-0 z-40 bg-black/50 w-12 hover:bg-black/70 hidden group-hover:flex items-center justify-center transition opacity-0 group-hover:opacity-100" onclick="scrollRow(this, -1)">
                <i class="fas fa-chevron-left text-2xl"></i>
            </button>
            
            <div class="flex gap-2 overflow-x-auto no-scrollbar scroll-smooth px-1" id="trending-row">
                <!-- Movie Cards (Populated via JS) -->
                <div class="text-gray-500 p-4">Loading trending movies...</div>
            </div>

            <button class="absolute right-0 top-0 bottom-0 z-40 bg-black/50 w-12 hover:bg-black/70 hidden group-hover:flex items-center justify-center transition opacity-0 group-hover:opacity-100" onclick="scrollRow(this, 1)">
                <i class="fas fa-chevron-right text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- Recommendations Row -->
    <div class="movie-row group">
        <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-100 hover:text-white transition cursor-pointer">Top Picks for You</h2>
        <div class="relative">
            <div class="flex gap-2 overflow-x-auto no-scrollbar scroll-smooth px-1" id="recommendations-row">
                <!-- Will be populated by JS -->
                <div class="text-gray-500 p-4">Loading recommendations...</div>
            </div>
        </div>
    </div>

</div>

<!-- Movie Detail Modal -->
<div id="movie-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black/80 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="relative inline-block align-bottom bg-[#181818] rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="relative h-[400px] md:h-[500px]">
                <div class="absolute inset-0 bg-gradient-to-t from-[#181818] via-transparent to-transparent z-10"></div>
                <img id="modal-img" src="" alt="Movie Cover" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-4 right-4 z-20 bg-[#181818] rounded-full p-2 hover:bg-white hover:text-black transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
                
                <div class="absolute bottom-10 left-4 md:left-12 z-20 max-w-2xl">
                    <h2 id="modal-title" class="text-4xl md:text-5xl font-bold mb-4">Movie Title</h2>
                    <div class="flex items-center gap-4 mb-6">
                        <a id="modal-play-btn" href="#" class="bg-white text-black px-8 py-2 rounded font-bold flex items-center gap-2 hover:bg-opacity-80 transition">
                            <i class="fas fa-play"></i> Play
                        </a>
                        <button class="border-2 border-gray-500 text-white rounded-full p-2 hover:border-white transition">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="border-2 border-gray-500 text-white rounded-full p-2 hover:border-white transition">
                            <i class="far fa-thumbs-up"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="px-4 md:px-12 py-8 grid md:grid-cols-3 gap-8">
                <div class="md:col-span-2 space-y-4">
                    <div class="flex items-center gap-4 text-sm font-medium">
                        <span class="text-[#46d369]">98% Match</span>
                        <span id="modal-year">2023</span>
                        <span class="border border-gray-500 px-1 text-xs">HD</span>
                    </div>
                    <p id="modal-overview" class="text-gray-300 leading-relaxed">
                        Overview text goes here...
                    </p>
                </div>
                <div class="text-sm text-gray-400 space-y-2">
                    <div><span class="text-gray-500">Cast:</span> <span class="text-white">Actor 1, Actor 2, Actor 3</span></div>
                    <div><span class="text-gray-500">Genres:</span> <span id="modal-genres" class="text-white">Action, Sci-Fi</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Track click event
    async function trackClick(movieId) {
        try {
            await fetch('/api/track-click', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ movie_id: movieId })
            });
            console.log('Click tracked for movie:', movieId);
        } catch (error) {
            console.error('Error tracking click:', error);
        }
    }

    // Helper to render movie cards
    function renderMovieCards(movies, containerId) {
        const container = document.getElementById(containerId);
        if (movies && movies.length > 0) {
            container.innerHTML = movies.map((movie, index) => {
                // Escape HTML to prevent XSS and syntax errors
                const safeTitle = escapeHtml(movie.title);
                const safePosterUrl = escapeHtml(movie.poster_url);
                
                return `
                    <div class="flex-none w-[160px] md:w-[240px] aspect-[2/3] relative rounded cursor-pointer transition duration-300 hover:scale-105 hover:z-30" 
                         data-movie-index="${index}"
                         data-container="${containerId}"
                         onclick="handleMovieClick('${containerId}', ${index})">
                        <img src="${safePosterUrl}" alt="${safeTitle}" class="w-full h-full object-cover rounded">
                        <div class="absolute inset-0 bg-black/40 opacity-0 hover:opacity-100 transition flex items-center justify-center">
                            <i class="fas fa-play-circle text-4xl text-white drop-shadow-lg"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Store movies data globally for access by click handler
            window.moviesData = window.moviesData || {};
            window.moviesData[containerId] = movies;
        } else {
            container.innerHTML = '<div class="text-gray-500 p-4">No movies found.</div>';
        }
    }
    
    // Escape HTML special characters
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // Handle movie click with data from global storage
    function handleMovieClick(containerId, index) {
        const movie = window.moviesData[containerId][index];
        if (movie) {
            trackClick(movie.id);
            openModalData(movie);
        }
    }

    // Fetch Recommendations
    async function fetchRecommendations() {
        try {
            const response = await fetch('/api/recommendations');
            const data = await response.json();
            renderMovieCards(data.results, 'recommendations-row');
        } catch (error) {
            console.error('Error fetching recommendations:', error);
        }
    }

    // Fetch Trending
    async function fetchTrending() {
        try {
            const response = await fetch('/api/trending');
            const data = await response.json();
            renderMovieCards(data.results, 'trending-row');
        } catch (error) {
            console.error('Error fetching trending:', error);
        }
    }

    // Modal Logic
    function openModal(index) {
        // Deprecated: Use openModalData instead
        console.warn('openModal is deprecated');
    }

    function openModalData(movie) {
        const modal = document.getElementById('movie-modal');
        document.getElementById('modal-title').innerText = movie.title;
        document.getElementById('modal-img').src = movie.poster_url.replace('w500', 'original'); // Try to get higher res
        document.getElementById('modal-overview').innerText = movie.overview;
        document.getElementById('modal-genres').innerText = movie.genres;
        document.getElementById('modal-year').innerText = movie.release_date || 'N/A';
        
        // Update Play Button Link
        const playBtn = document.getElementById('modal-play-btn');
        playBtn.href = `/watch/${movie.id}`;

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('movie-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Scroll Logic
    function scrollRow(btn, direction) {
        const row = btn.parentElement.querySelector('div');
        const scrollAmount = row.clientWidth * 0.8;
        row.scrollBy({
            left: direction * scrollAmount,
            behavior: 'smooth'
        });
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        fetchRecommendations();
        fetchTrending();
    });
</script>
{% endblock %}
